<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  stroke: #999;
    stroke-opacity: .6;
}

.node {
  stroke: #fff;
    stroke-width: 1.5px;
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

var width = 2000,
    height = 1000;

var scaleFactor = 1;
var translation = [0,0];

// Initilize Ordinal Colour Scale
var color = d3.scale.ordinal()
        .domain(["02", "03", "04", "05", "06", "07", "13", "14", "15", "21", "22", "23", "24"])
        .range([
            "#009933", // Science
            "#ff0000", // Engineering
            "#003366", // Health Science
            "#ffff00", // Nursing
            "#996633", // Business
            "#ff9933", // Arts and Science
            "#cc00cc", // Divinity
            "#ffcccc", // Humanities
            "#ff66ff", // Social Science
            "#0000cc", // Medicine
            "#cc9900", // Midwifery
            "#00ccff", // Interns and Residents
            "#ffff00"  // Collaborative Nursing
]);

 // Configure force layout
var force = d3.layout.force()
    .size([width, height]);



d3.tsv("Program Faculty Lookup.txt", function(error, lookup) {
    if(error) throw error;
    var lookupTable = {};
    lookup.forEach(function(program) {
        lookupTable[program.name] = program.faculty;
    });
    console.log(lookupTable);

    d3.tsv("3-year program transfer.txt", function(error, links) {
        if (error) throw error;

        /*** Configure zoom behaviour ***/
        var zoomer = d3.behavior.zoom()
                        .scaleExtent([0.1,10])
                //allow 10 times zoom in or out
                        .on("zoom", zoom);
                //define the event handler function

        function zoom() {
            console.log("zoom", d3.event.translate, d3.event.scale);
            scaleFactor = d3.event.scale;
            translation = d3.event.translate;
            tick(); //update positions
        }

        /*** Configure drag behaviour ***/
        var drag = d3.behavior.drag()
            .origin(function(d) { return d; }) //center of circle
            .on("dragstart", dragstarted)
            .on("drag", dragged)
            .on("dragend", dragended);

        function dragstarted(d){
            console.log("dragstarted");
            d3.event.sourceEvent.stopPropagation();
            d3.select(this).classed("dragging", true);
          //  force.stop(); //stop ticks while dragging
        }
        function dragged(d){
            if (d.fixed) return; //root is fixed

            //get mouse coordinates relative to the visualization
            //coordinate system:
            var mouse = d3.mouse(vis.node());
            d.x = (mouse[0] - translation[0])/scaleFactor;
            d.y = (mouse[1] - translation[1])/scaleFactor;
            tick();//re-position this node and any links
        }
        function dragended(d){
            d3.select(this).classed("dragging", false);
          //  force.resume();
        }


        //Initialize SVG
        var graph = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("class", "graph")
            .call(zoomer);

        // Rectangle to catch mouse events for zoom
        var rect = graph.append("rect")
            .attr("width", width)
            .attr("height", height)
        //    .style("fill", "none")
            .style("pointer-events", "all");

        // Create a group that will hold all content to be zoomed
        var vis = graph.append("svg:g")
            .attr("class", "plotting-area");

        var nodesByName = {};

        // Create nodes for each unique source and target.
        links.forEach(function(link) {
            link.source = nodeByName(link.source);
            link.target = nodeByName(link.target);
        });

        // Extract the array of nodes from the map by name.
        var nodes = d3.values(nodesByName);

        // Create the link lines.
        var link = vis.selectAll(".link")
              .data(links)
            .enter().append("line")
              .attr("class", "link");

        // Create the node circles.
        var node = vis.selectAll(".node")
              .data(nodes)
            .enter().append("circle")
              .attr("class", "node")
              .attr("r", 4.5)
              .style("fill", function(d) {return color(lookupTable[d.name]);})
              .call(drag);

        // Add program name
        node.append("title")
            .text(function(d) {return d.name;})

        // Start the force layout.
        force
              .nodes(nodes)
              .links(links)
              .linkDistance(40)
        //      .linkStrength(0.08)
              .on("tick", function(){tick();})
              .start();






        function tick() {
            link.attr("x1", function(d) { return translation[0] + scaleFactor*d.source.x; })
                .attr("y1", function(d) { return translation[1] + scaleFactor*d.source.y; })
                .attr("x2", function(d) { return translation[0] + scaleFactor*d.target.x; })
                .attr("y2", function(d) { return translation[1] + scaleFactor*d.target.y; });

            node.attr("cx", function(d) { return translation[0] + scaleFactor*d.x; })
                .attr("cy", function(d) { return translation[1] + scaleFactor*d.y; });
        }



        function nodeByName(name) {
            return nodesByName[name] || (nodesByName[name] = {name: name});
        }
    });

});

</script>
