<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .link {
        stroke: #999;
        stroke-opacity: .6;
    }

    .node {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        line-height: 1;
        padding: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
        pointer-events: none;
        font-family: 'Roboto', sans-serif;
    }
    g {
        font-family: 'Roboto', sans-serif;
    }
    .cell {
        cursor: pointer;
    }


</style>
<body>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="js/d3-legend.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script>
//            var width = 2000,
//                height = 535;

            var scaleFactor = 1;
            var translation = [0,0];

            var smallCircleSize = 4.5;
            var largeCircleSize = 9;

            // Linear size scale
            var linearSize = d3.scale.linear().domain([0,1]).range([smallCircleSize, largeCircleSize]);

            // Initialize Ordinal Colour Scale
            var color = d3.scale.ordinal()
                .domain(["02", "03", "04", "05", "06", "07", "13", "14", "15", "21", "22", "23", "24"])
                .range([
                    "#009933", // Science
                    "#ff0000", // Engineering
                    "#003366", // Health Science
                    "#ffff00", // Nursing
                    "#996633", // Business
                    "#ff9933", // Arts and Science
                    "#cc00cc", // Divinity
                    "#ffcccc", // Humanities
                    "#ff66ff", // Social Science
                    "#0000cc", // Medicine
                    "#cc9900", // Midwifery
                    "#00ccff", // Interns and Residents
                    "#ffff00"  // Collaborative Nursing
            ]);
        // Faculty Name to Number
        var lookupTableName = {
            "Science": "02",
            "Engineering": "03",
            "Health Science": "04",
            "Nursing": "05",
            "Business": "06",
            "Arts and Science": "07",
            "Divinity": "13",
            "Humanities": "14",
            "Social Science": "15",
            "Medicine": "21",
            "Midwifery": "22",
            "Interns and Residents": "23",
            "Collaborative Nursing": "24"
        };
        console.log(lookupTableName);


            // Configure force layout
            var force = d3.layout.force();

        queue()
            .defer(d3.tsv, "Program-Faculty-Lookup.txt")
            .defer(d3.tsv, "3-year-program-transfer.txt")
            .await(ready);

        function ready(error, lookup, links){
            if (error) throw error;

            // The 'lookup' variable refers to data from the Program-Faculty-Lookup.txt file
            // The 'linnks' variable refers to data from the 3-year-program-transfer.txt file

            // Set up Program/Faculty lookup table
            var lookupTable = {};
            lookup.forEach(function(program) {
                lookupTable[program.name] = program.faculty;
            });
            console.log(lookupTable);

            /*** Configure zoom behaviour ***/
            var zoomer = d3.behavior.zoom()
                            .scaleExtent([0.1,10])
                    //allow 10 times zoom in or out
                            .on("zoom", zoom);
                    //define the event handler function

            function zoom() {
                console.log("zoom", d3.event.translate, d3.event.scale);
                scaleFactor = d3.event.scale;
                translation = d3.event.translate;
                tick(); //update positions
            }

            /*** Configure drag behaviour ***/
            var drag = d3.behavior.drag()
                .origin(function(d) { return d; }) //center of circle
                .on("dragstart", dragstarted)
                .on("drag", dragged)
                .on("dragend", dragended);

            function dragstarted(d){
                d3.event.sourceEvent.stopPropagation();
                d3.select(this).classed("dragging", true);
              //  force.stop(); //stop ticks while dragging
                force.stop(); //stop ticks while dragging
            }
            function dragged(d){
                if (d.fixed) return; //root is fixed

                //get mouse coordinates relative to the visualization
                //coordinate system:
                var mouse = d3.mouse(vis.node());
                d.x = (mouse[0] - translation[0])/scaleFactor;
                d.y = (mouse[1] - translation[1])/scaleFactor;
                tick();//re-position this node and any links
            }
            function dragended(d){
                d3.select(this).classed("dragging", false);
                force.resume();
            }



            //Initialize SVG
            var graph = d3.select("body").append("svg")
              .append("g")
                .attr("class", "graph")
                .call(zoomer);

            // Rectangle to catch mouse events for zoom
            var rect = graph.append("rect")
                .attr("width", "80%")
                .attr("height", "100%")
                .attr("x", "10%")
         //       .style("margin", "0 auto")
                .style("fill", "none")
                .style("pointer-events", "all")

            // Tooptip in top left corner
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .attr("x", "10%")
                .style("opacity", "0");

            // Create a group that will hold all content to be zoomed
            var vis = graph.append("svg:g")
                .attr("class", "plotting-area");

            // Create a legend
            graph.append("g")
                .attr("class", "legendOrdinal")
                .attr("transform", "translate(20,100)");

            var legend = d3.legend.color()
                .shape("circle")
                .shapePadding(10)
                .scale(color)
                .labels(["Science",
                         "Engineering",
                         "Health Science",
                         "Nursing",
                         "Business",
                         "Arts and Science",
                         "Divinity",
                         "Humanities",
                         "Social Science",
                         "Medicine",
                         "Midwifery",
                         "Interns and Residents",
                         "Collaborative Nursing"
                        ]);

            graph.select(".legendOrdinal")
                .call(legend);

            d3.selectAll(".cell")
                .on("click", function(d){
                    if (d3.event.defaultPrevented) return;
                    console.log("searchNode Called");
                    searchNode(d);

                });


            graph.append("g")
                .attr("class", "legendSize")
                .attr("transform", "translate(20, 500)");

            var legendSize = d3.legend.size()
                .scale(linearSize)
                .shape('circle')
                .shapePadding(15)
                .labels(["Other","Entry-level Program"])
                .cells(2) // Number of objects (circles)
                .ascending(true);

            graph.select(".legendSize")
                .call(legendSize);

            // Create nodes for each unique source and target.
            var nodesByName = {};
            links.forEach(function(link) {
                link.source = nodeByName(link.source);
                link.target = nodeByName(link.target);
            });
            function nodeByName(name) {
                return nodesByName[name] || (nodesByName[name] = {name: name});
            }

            // Extract the array of nodes from the map by name.
            var nodes = d3.values(nodesByName);

            // Create the link lines.
            var link = vis.selectAll(".link")
                  .data(links)
                .enter().append("line")
                  .attr("class", "link");

            var timeout;
            // Create the node circles.
            var node = vis.selectAll(".node")
                  .data(nodes)
                .enter().append("circle")
                  .attr("class", "node")
                  .attr("r", function(d) {
                      if(d.name == "NURSING" ||
                         d.name == "ENGINEERING 1" ||
                         d.name == "ENGINEERING 1 CO-OP" ||
                         d.name == "ENVIRONMENTAL & EARTH SCIENCES 1" ||
                         d.name == "HUMANITIES 1" ||
                         d.name == "SOCIAL SCIENCES 1" ||
                         d.name == "INTEGRATED SCIENCE 1" ||
                         d.name == "ARTS & SCIENCE 1" ||
                         d.name == "COMPUTER SCIENCE 1" ||
                         d.name == "COMPUTER SCIENCE 1 CO-OP" ||
                         d.name == "BUSINESS 1" ||
                         d.name == "BUSINESS" ||
                         d.name == "LIFE SCIENCES 1" ||
                         d.name == "MATHEMATICS & STATISTICS 1" ||
                         d.name == "MEDICAL RADIATION SCIENCES" ||
                         d.name == "MUSIC 1" ||
                         d.name == "PHYSICAL SCIENCES 1" ||
                         d.name == "STUDIO ART I" ||
                         d.name == "TECHNOLOGY 1" ||
                         d.name == "HONOURS BACHELOR OF HEALTH SCIENCES" ||
                         d.name == "HONOURS KINESIOLOGY 1" ||
                         d.name == "MIDWIFERY" ||
                         d.name == "MEDICINE"
                        ){
                          return largeCircleSize;
                      }
                      else{return smallCircleSize}
                  })
                  .style("fill", function(d) {return color(lookupTable[d.name]);})
                  .on("click", function(d){
                      if (d3.event.defaultPrevented) return; // click suppressed
                      console.log(d);
                      connectedNodes(d); // else highlight connected nodes
                  })
                  .on("mouseover", function(d){
                      if(d3.select(this).style("opacity") == 1){
                          div.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                      div.html(d.name)
                        .style("left", "10px")
                        .style("top", "10px");
                      }
                  })
                  .on("mouseout", function(d){
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                  })
                  .call(drag);

            // Add program name
            node.append("title")
                .text(function(d) {return d.name;})

            // Start the force layout.
            force
                  .nodes(nodes)
                  .links(links)
                  .linkDistance(40)
            //      .linkStrength(0.08)
                  .on("tick", function(){tick();})
                  .start();

            /* Configure highlighting of connected nodes */
            var toggle = 0;

            //Create an array logging what is connected to what
            var linkedByIndex = {};
            for (i = 0; i < nodes.length; i++) {
                linkedByIndex[i + "," + i] = 1;
            };
            links.forEach(function (d) {
                linkedByIndex[d.source.index + "," + d.target.index] = 1;

            });

            //This function looks up whether a pair are neighbours
            function neighboring(a, b) {
                return linkedByIndex[a.index + "," + b.index];
            }

            // Change opacity to highlight connected nodes
            function connectedNodes(clickedOn) {
                if(toggle == 0){
                    //Reduce the opacity of all but the neighbouring nodes
                   // d = d3.select(clickedOn).node().__data__;
                    node.style("opacity", function (o) {
                        return neighboring(clickedOn, o) | neighboring(o, clickedOn) ? 1 : 0.1;
                    });
                    link.style("opacity", function (o) {
                        return clickedOn.index==o.source.index | clickedOn.index==o.target.index ? 1 : 0.1;
                    });
                    toggle = 1;
                }
                else {
                    //Put them back to opacity=1
                    node.style("opacity", 1);
                    link.style("opacity", 1);
                    toggle = 0;
                }

            }
            function searchNode(searchVal) {
                var searchNode = d3.selectAll(".node");
                var selected = searchNode.filter(function (d, i){
                    return lookupTable[d.name] != searchVal
                });
                selected.style("opacity", "0.1");
                var link = d3.selectAll(".link");
                link.style("opacity", "0.1");
                d3.selectAll(".node, .link").transition()
                    .duration(5000)
                    .style("opacity", "1");
                console.log(selected);
            }

            resize();
            d3.select(window).on("resize", resize);

            // Update positions of nodes and links
            function tick() {
                link.attr("x1", function(d) { return translation[0] + scaleFactor*d.source.x; })
                    .attr("y1", function(d) { return translation[1] + scaleFactor*d.source.y; })
                    .attr("x2", function(d) { return translation[0] + scaleFactor*d.target.x; })
                    .attr("y2", function(d) { return translation[1] + scaleFactor*d.target.y; });

                node.attr("cx", function(d) { return translation[0] + scaleFactor*d.x; })
                    .attr("cy", function(d) { return translation[1] + scaleFactor*d.y; });
            }

            function resize() {
                console.log("resize");
                width = window.innerWidth, height = window.innerHeight;
                d3.select("svg").attr("width", width).attr("height", height);
                force.size([width, height]).resume();
            }


        }
        </script>
</body>
